# Base compose file.

services:

  testdb: # dev only
    image: redis/redis-stack-server
    container_name: pbot-redis-test
    ports:
    - '1111:6379'
    platform: linux/arm64
    networks:
    - backend

  redis:
    image: redis/redis-stack-server
    container_name: pbot-redis
    ports:
    - '6379:6379'
    platform: linux/arm64
    volumes:
     - redis_data:/data
    networks:
    - backend

  redis-insight: # dev only
    image: redis/redisinsight:latest
    container_name: pbot-redis-insight
    ports:
    - '5540:5540'
    # platform: linux/arm64
    depends_on:
    - redis
    networks:
    - frontend
    - backend
    volumes:
     - redis_insight:/data


  bot:
    container_name: pbot-bot
    build:
      context: ../
      dockerfile: services/bot/Dockerfile
    ports:
    - "6666:6666"
    volumes:
    - ../services/bot/src:/src
    depends_on:
    - redis
    networks:
    - backend
    environment:
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - OPENAI_KEY=${OPENAI_KEY}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - TEST_REDIS_HOST=${TEST_REDIS_HOST}
      - TEST_REDIS_PORT=${TEST_REDIS_PORT}

  transceiver:
    container_name: pbot-transceiver
    build:
      context: ./services/transceiver
      dockerfile: Dockerfile
    volumes:
    - ../services/transceiver/src:/src
    depends_on:
    - redis
    networks:
    - backend
    environment:
      - DISCORD_TOKEN=${DISCORD_TOKEN}

  admin:
    build:
      context: ./services/admin
      dockerfile: Dockerfile
    container_name: pbot-admin
    ports:
    - "7777:7777"
    volumes:
    - ../services/admin/src:/src
    depends_on:
    - redis
    networks:
    - frontend
    - backend

volumes:
  redis_data:
  redis_insight:

networks:
  backend:
  frontend:
